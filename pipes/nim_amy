#!/usr/bin/bash
PIPE_FOR="MJ"
PIPE_DESC80="Reproduce amy conn from doi: 10.1016/j.neuroimage.2014.03.038"
PIPE_DESC="
Attempt to copy the pipeline from
The development of human amygdala functional connectivity at rest from 4 to 23 years: a cross-sectional study.
bandpass globalwm episize 1mm 
"
PIPE_DEPENDS=() # FS
PIPE_VERSION="20160210"
FINALPREFIX="nim"
FINALOUT=("afni/${FINALPREFIX}.cleanEPI+tlrc.HEAD" ".afni_complete" )


# this is hopefully elsewhere too. at least a nice reminder we have BRIK.gz files
#export AFNI_COMPRESSOR="GZIP"
export AUTOGZIP="YES"

function check_complete {
 wantonlyoneid $@ || return 1
 has_finalout  $1 || return 1
 return 0
}


function run_pipeline {
 wantonlyoneid $@ || return 1
 id="$1"

 starttime=$(date +%s)

 # make a directory for this subject
 [ -d $id ] && rm -r $id
 mkdir $id
 cd $id

 # outher source files (not reward) will return path to e.g. MR*
  epi="$(subj_t2_construct $id)"
 anat="$(subj_t1 $id)"
 aseg="$(subj_FS_aseg $id)"
 # we threw warnings if any failed. make sure we dont continue
 [ -z "$anat" -o -z "$epi" -o -z "$aseg" ] && return 1

 # make sure we're gziping everything

 ## start recording whats going on, and die if something goes wrong
 #set -xe

 ##### 
 # from the paper
 # AFNI
 #  discarding the first 4 functional volumes to allow for BOLD signal stabilization
 #  correction for slice acquisition dependent time shifts per volume
 #  rigid body translation and rotation from each volume to the first volume to generate 6 within-subject motion regressors
 #  spatial smoothing: 6-mm Gaussian kernel (FWHM) 
 #  censor > 2.5 mm or 2.5Â° in any direction as compared to the first functional volume 
 #  regs:  (15 total)
 #     3 translational and 3 rotational,  6 backward temporal derivatives
 #     global signal regressor, white-matter, ventricle regressors 
 #
 #     #### NB #### afni defaults to derive of every regs. so actually 18 regs
 #
 #  the mean absolute displacement value -> covariate in the regressions 
 # normalized to percent signal change 
 # transformed to the standard coordinate space of Talairach and Tournoux (1988) 
 #   resampled resolution of 1 mm3
 # band-pass filter (0.009 Hz < f < 0.08 Hz)   ### AFNI defult
 # Timecourses for the right ventricle, white matter, and the global signal were then extracted as nuisance covariates to account for external contamination of the remaining resting-state frequencies.

 set -xe

 # afni likes the EPI to be in the directory the script will run from
 3dcopy ${epi//+orig.HEAD/+orig} epi+orig

 [ ! -r epi+orig.BRIK.gz ] &&  err "afni 3dcopy broken? $(pwd)/epi*"

 # -bpassregs # should be included
 afni_restproc.py \
   -despike off \
   -aseg $aseg \
   -anat $anat \
   -epi epi+orig \
   -script nim.tcsh \
   -dest afni \
   -prefix "$FINALPREFIX" \
   \
   -trcut 4 \
   -episize 1 \
   -tlrc \
   -dreg \
   -smoothfirst \
   -smoothrad 6 \
   -smoothtogether \
   -bandpass \
   -polort 0 \
   \
   -globalwm \
   -modenorm \
   \
   -exec off 

  # this causes eroded to be empty
  # \
  # -venterode 0 \
  # -wmerode 0 \
 
 #return 0
 # -includebrain \


 #### EDIT afni script
 # we need to change some of the script afni generated
 # hence the -exec off above, we'll need to call nim.tcsh 
 # namely to add special censoring
 # --> anything greather than 2.5 from the first volume
 # TODO: what scale is afni motion.1D; meters?

 cd afni

 
 # we want to add this code to the script generated by afni
 # -- this find any value grather than 2.5 and flags it for censoring in "nim.censor.1D"
 cat > censorscript.tsch <<EOF

 ## injected censor script
 #  1's in c will be kept, 0's will be discarded
 perl -slane 'print( grep({abs($_)>2.5} @F)?0:1 )' epi*_motion.tcat.1D > nim.censor.1D
 afni_restproc.py -apply_censor epi.float_tlrc_al.tcat.norm.blur.bpass.clean+tlrc nim.censor.1D epi.float_tlrc_al.tcat.norm.blur.bpass.clean.censor
 3dcopy epi.float_tlrc_al.tcat.norm.blur.bpass.clean.censor ../nim.cleanEPI
 cp nim.censor.1D ../

EOF

 # comment out the origianl nim.cleanEPI coppy
 sed -ie 's:3dcopy .* ../nim.cleanEPI:  #& # original copy before censor was injected:' nim.tcsh
 # inject the code above into the afni script with sed ("r" inserts the script file after the line that copies T1+trlc)
 sed -ie '/3dcopy T1+tlrc/r./censorscript.tsch' nim.tcsh

 #### /DONE EDITING




 ## ACTUALLY RUN
 tcsh ./nim.tcsh

 # write out our own finish file
 echo -e "$(echo $(date +%s) - $starttime | bc -l) secs\n$(pwd)\t$(date)\t${FUNC_NAME}" > ../.afni_complete
 rm ../epi+*

 return 0
}
